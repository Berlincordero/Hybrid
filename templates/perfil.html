{% load static %}
{% load i18n %}

<!DOCTYPE html>
<html lang="{{ LANGUAGE_CODE }}">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% trans "Perfil de Usuario" %}</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <script src="https://unpkg.com/@lottiefiles/lottie-player@latest/dist/lottie-player.js"></script>
    <style>
        .circle-container {
            width: 12rem; /* 192px */
            height: 12rem; /* 192px */
            position: relative;
        }

        .lottie-icon {
            position: absolute;
            top: 0%; /* Posición relativa al círculo */
            bottom: 10%; /* Posición relativa al círculo */
            right: 2%; /* Ajustado hacia la esquina */
            width: 100px; /* Ancho del Lottie */
            height: 100px; /* Altura del Lottie */
        }

        @media (min-width: 768px) { /* Pantallas medianas */
            .circle-container {
                width: 16rem; /* 256px */
                height: 16rem; /* 256px */
            }
            .lottie-icon {
                width: 100px;
                height: 100px;
            }
        }

        @media (min-width: 1024px) { /* Pantallas grandes */
            .circle-container {
                width: 20rem; /* 320px */
                height: 20rem; /* 320px */
            }
            .lottie-icon {
                margin-top: 11rem;
                width: 170px;
                height: 170px;
            }
        }

        /* === Aquí forzamos que los campos se vean como texto sin caja ni sombreado === */
        input[type="text"],
        input[type="date"],
        input[type="email"],
        input[type="password"],
        textarea,
        select {
            background-color: transparent !important;
            border: none !important;
            box-shadow: none !important;
            outline: none !important;
            color: inherit; /* Mantiene el color de texto (blanco) */
            padding: 0 !important; 
            /* Si deseas dejar un poco de espacio, cambia "0" a lo que quieras */
        }
    </style>
</head>
<body class="bg-gray-900 text-white min-h-screen flex flex-col items-center justify-center space-y-6">
    <!-- Enlace para regresar al inicio -->
    <div class="w-full max-w-4xl text-left px-6">
        <a href="{% url 'index' %}" target="_blank" class="flex flex-row items-center text-white hover:text-indigo-400">
            <!-- Ícono Lottie -->
            <lottie-player
                src="{% static 'animations/Inicio.json' %}"
                background="transparent"
                speed="1"
                style="width: 50px; height: 50px;"
                loop
                autoplay>
            </lottie-player>
            <!-- Texto del enlace -->
            <span class="ml-2">
                {% trans "Volver al inicio" %}
            </span>
        </a>
    </div>
    

    <div class="w-full max-w-4xl bg-gray-800 p-6 rounded-xl shadow-md">
        <!-- Sección de perfil -->
        <div class="flex flex-col lg:flex-row lg:items-start lg:space-x-12">
            <!-- Foto de perfil -->
            <div class="flex flex-col items-center">
                <div class="circle-container rounded-full bg-gray-600 flex items-center justify-center overflow-hidden">
                    {% if perfil.foto_perfil %}
                    <img src="{{ perfil.foto_perfil.url }}" alt="{% trans 'Foto de Perfil' %}" class="w-full h-full object-cover">
                    {% else %}
                    <span class="text-gray-400">{% trans "Sin Foto" %}</span>
                    {% endif %}

                    <!-- Lottie para subir la foto -->
                    <label for="foto_perfil" class="lottie-icon cursor-pointer">
                        <lottie-player
                            src="{% static 'animations/foto.json' %}"
                            background="transparent"
                            speed="1"
                            loop
                            autoplay
                        ></lottie-player>
                    </label>
                </div>
                <form id="foto-perfil-form" method="post" enctype="multipart/form-data" action="{% url 'actualizar_foto_perfil' %}" class="mt-4">
                    {% csrf_token %}
                    <input type="file" name="foto_perfil" id="foto_perfil" class="hidden" onchange="guardarFoto()">
                    <button type="button" onclick="document.getElementById('foto_perfil').click()" class="text-sm text-indigo-500 hover:underline">
                    </button>
                </form>
            </div>

            <!-- Formulario de perfil -->
            <form method="post" class="space-y-4 flex-1" id="profileForm">
                {% csrf_token %}
                {{ form.non_field_errors }}

                <!-- Encabezado con nombre, fecha y género -->
                <div class="text-center mb-8">
                    <p class="text-gray-300 text-lg mt-2">
                        <strong>{{ request.user.first_name }} {{ request.user.last_name }}</strong>
                    </p>
                    
                    <!-- MOSTRAR FECHA DE NACIMIENTO (modelo "Perfil") -->
                    <p class="text-gray-300 text-md mt-2">
                        {% trans "fecha de nacimiento:" %}
                        {{ perfil.fecha_nacimiento|date:"d/m/Y" }}
                    </p>

                    <!-- MOSTRAR FECHA DE NACIMIENTO (modelo "Profile" - app Administrador) -->
                    <p class="text-gray-300 text-md mt-2">
                        {% trans "" %}
                        {{ profile.birth_date|date:"d/m/Y" }}
                    </p>

                    <!-- MOSTRAR GÉNERO (modelo "Profile") -->
                    <p class="text-gray-300 text-md mt-2">
                        {% trans "Género (Profile):" %}
                        {{ profile.get_gender_display }}
                    </p>
                </div>

                <!-- Campo: Dirección -->
                <div>
                    <label for="{{ form.direccion.id_for_label }}" class="block font-medium text-gray-200">
                        {% trans "Dirección" %}
                    </label>
                    {{ form.direccion }}
                    <div class="mt-2 space-x-2">
                        <button 
                            type="button" 
                            class="editFieldBtn text-sm text-indigo-500 hover:underline"
                            data-target="id_direccion"
                        >
                            {% trans "Editar" %}
                        </button>
                        <button 
                            type="button" 
                            class="saveFieldBtn text-sm text-indigo-500 hover:underline hidden"
                            data-target="id_direccion"
                        >
                            {% trans "Guardar" %}
                        </button>
                    </div>
                </div>

                <!-- Campo: Actividad Económica -->
                <div>
                    <label for="{{ form.actividad_economica.id_for_label }}" class="block font-medium text-gray-200">
                        {% trans "Actividad Económica" %}
                    </label>
                    {{ form.actividad_economica }}
                    <div class="mt-2 space-x-2">
                        <button 
                            type="button" 
                            class="editFieldBtn text-sm text-indigo-500 hover:underline"
                            data-target="id_actividad_economica"
                        >
                            {% trans "Editar" %}
                        </button>
                        <button 
                            type="button" 
                            class="saveFieldBtn text-sm text-indigo-500 hover:underline hidden"
                            data-target="id_actividad_economica"
                        >
                            {% trans "Guardar" %}
                        </button>
                    </div>
                </div>

                <!-- Campo: Preferencias Agropecuarias -->
                <div>
                    <label for="{{ form.preferencias_agropecuarias.id_for_label }}" class="block font-medium text-gray-200">
                        {% trans "Preferencias Agropecuarias" %}
                    </label>
                    {{ form.preferencias_agropecuarias }}
                    <div class="mt-2 space-x-2">
                        <button 
                            type="button" 
                            class="editFieldBtn text-sm text-indigo-500 hover:underline"
                            data-target="id_preferencias_agropecuarias"
                        >
                            {% trans "Editar" %}
                        </button>
                        <button 
                            type="button" 
                            class="saveFieldBtn text-sm text-indigo-500 hover:underline hidden"
                            data-target="id_preferencias_agropecuarias"
                        >
                            {% trans "Guardar" %}
                        </button>
                    </div>
                </div>

                <!-- Campo: Preferencias Comerciales -->
                <div>
                    <label for="{{ form.preferencias_comerciales.id_for_label }}" class="block font-medium text-gray-200">
                        {% trans "Preferencias Comerciales" %}
                    </label>
                    {{ form.preferencias_comerciales }}
                    <div class="mt-2 space-x-2">
                        <button 
                            type="button" 
                            class="editFieldBtn text-sm text-indigo-500 hover:underline"
                            data-target="id_preferencias_comerciales"
                        >
                            {% trans "Editar" %}
                        </button>
                        <button 
                            type="button" 
                            class="saveFieldBtn text-sm text-indigo-500 hover:underline hidden"
                            data-target="id_preferencias_comerciales"
                        >
                            {% trans "Guardar" %}
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Script para envío automático de la foto -->
    <script>
        function guardarFoto() {
            const form = document.getElementById('foto-perfil-form');
            form.submit();
        }
    </script>

    <!-- Script para habilitar/deshabilitar cada campo y guardar -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Todos los inputs del formulario
            const allInputs = document.querySelectorAll('#profileForm input, #profileForm textarea, #profileForm select');
            // Todos los botones "Editar"
            const editButtons = document.querySelectorAll('.editFieldBtn');
            // Todos los botones "Guardar"
            const saveButtons = document.querySelectorAll('.saveFieldBtn');

            // 1. Deja todos los campos en modo lectura al cargar
            allInputs.forEach(input => {
                if (input.type !== 'hidden' && input.name !== 'csrfmiddlewaretoken') {
                    input.setAttribute('readonly', true);
                }
            });

            // 2. Botones "Editar" -> habilita el campo
            editButtons.forEach(btn => {
                btn.addEventListener('click', function() {
                    const targetId = this.getAttribute('data-target');
                    const targetInput = document.getElementById(targetId);
                    if (targetInput) {
                        // Quita el modo lectura
                        targetInput.removeAttribute('readonly');
                        // Muestra el botón Guardar y oculta Editar
                        const saveBtn = this.parentNode.querySelector('.saveFieldBtn');
                        this.classList.add('hidden');
                        saveBtn.classList.remove('hidden');
                    }
                });
            });

            // 3. Botones "Guardar" -> re-habilita readonly y envía el formulario
            saveButtons.forEach(btn => {
                btn.addEventListener('click', function() {
                    const targetId = this.getAttribute('data-target');
                    const targetInput = document.getElementById(targetId);
                    if (targetInput) {
                        // Vuelve a poner el campo en modo lectura
                        targetInput.setAttribute('readonly', true);
                        // Envía el formulario (para que se guarde en la BD)
                        document.getElementById('profileForm').submit();
                    }
                });
            });
        });
    </script>
</body>
</html>
